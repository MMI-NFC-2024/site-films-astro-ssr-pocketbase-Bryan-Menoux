---
import Layout from "../../../layouts/Layout.astro";
import slug from "slug";
import {
  FilmsPaysOptions,
  type FilmsResponse,
} from "../../../pocketbase-types";
import { formatDate } from "../../../utils/utilitaires";
import GenresSelect from "../../../components/GenresSelect.astro";

const { id } = Astro.params;
let message = null;

let film = {} as FilmsResponse;
if (id) {
  film = await Astro.locals.pb.collection("films").getOne(id);
}

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();

  const filmCree = await (
    id
      ? Astro.locals.pb.collection("films").update(id!, data)
      : Astro.locals.pb.collection("films").create(data)
  ).catch((err) => {
    console.error("Erreur de sauvegarde du film : ", err);
    message = err.message;
    console.log("Message d'erreur :", message);
  });
  if (filmCree) {
    return Astro.redirect(`/films/${filmCree.id}-${slug(filmCree.titre)}`);
  }
}

const afficheUrl = film.affiche
  ? Astro.locals.pb.files.getURL(film, film.affiche)
  : null;

const personnesListe = await Astro.locals.pb
  .collection("personnes")
  .getFullList();
---

<Layout>
  <h1>{id ? "Modifier un film" : "Ajouter un film"}</h1>
  {message && <p class="text-red-500">{message}</p>}
  <form method="post" enctype="multipart/form-data" class="max-w-xl" id="film-form">
    {id && <input type="hidden" name="id" value={id} />}
    <input
      type="hidden"
      name="user"
      value={Astro.locals.pb.authStore.record?.id}
    />
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Titre :</span>
      <input
        type="text"
        name="titre"
        value={film.titre || ""}
        class="w-full border border-gray-300 rounded px-3 py-2"
      />
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Date de sortie :</span>
      <input
        type="date"
        name="date_sortie"
        value={film.date_sortie ? formatDate(film.date_sortie) : ""}
        class="w-full border border-gray-300 rounded px-3 py-2"
      />
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Durée (en minutes):</span>
      <input
        type="number"
        name="duree_min"
        value={film.duree_min || ""}
        class="w-full border border-gray-300 rounded px-3 py-2"
      />
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Synopsis :</span>
      <textarea
        name="synopsis"
        rows="10"
        class="w-full border border-gray-300 rounded px-3 py-2"
        >{film.synopsis || ""}</textarea
      >
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Réalisateur :</span>
      <select
        name="realisateur"
        class="w-full border border-gray-300 rounded px-3 py-2"
      >
        <option>Choisir un réalisateur</option>
        {
          personnesListe.map(({ nom, prenom, id }) => (
            <option value={id} selected={film.realisateur === id}>
              {prenom} {nom}
            </option>
          ))
        }
      </select>
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Producteur(s) :</span>
      <select
        name="producteur"
        class="w-full border border-gray-300 rounded px-3 py-2"
        multiple
      >
        <option>Choisir un producteur ou plusieurs producteurs</option>
        {
          personnesListe.map(({ nom, prenom, id }) => (
            <option value={id} selected={film.producteur?.some(producteur => producteur === id)}>
              {prenom} {nom}
            </option>
          ))
        }
      </select>
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Acteur(s) :</span>
      <select
        name="acteur"
        class="w-full border border-gray-300 rounded px-3 py-2"
        multiple
      >
        <option>Choisir un acteur ou plusieurs acteurs</option>
        {
          personnesListe.map(({ nom, prenom, id }) => (
            <option value={id} selected={film.acteur?.some(acteur => acteur === id)}>
              {prenom} {nom}
            </option>
          ))
        }
      </select>
    </label>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Affiche :</span>
      <input
        type="file"
        name="affiche"
        id="affiche-input"
        accept="image/*"
        class="w-full border border-gray-300 rounded px-3 py-2"
      />
      {
        afficheUrl && (
          <div class="mt-2">
            <span class="block text-gray-600 mb-1">Affiche actuelle :</span>
            <img
              src={afficheUrl}
              alt="Affiche du film"
              class="max-w-xs border"
            />
          </div>
        )
      }
      <div id="preview-container" class="mt-2 hidden">
        <span class="block text-gray-600 mb-1">Nouvelle affiche :</span>
        <img id="preview" alt="Prévisualisation" class="max-w-xs border" />
      </div>
    </label>
    <div class="block mb-4">
      <GenresSelect selectedGenres={film.genres} />
    </div>
    <label class="block mb-4">
      <span class="block text-gray-700 mb-2">Pays :</span>
      <select name="pays" id="pays-input" value={film.pays || ""}>
        {
          Object.entries(FilmsPaysOptions).map(([key, value]) => (
            <option value={value} selected={film.pays === value}>
              {key}
            </option>
          ))
        }
      </select>
    </label>
    <button
      type="submit"
      class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
    >
      {id ? "Mettre à jour" : "Ajouter"}
    </button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("film-form") as HTMLFormElement;
      const input = document.getElementById(
        "affiche-input",
      ) as HTMLInputElement;
      const preview = document.getElementById("preview") as HTMLImageElement;
      const container = document.getElementById(
        "preview-container",
      ) as HTMLDivElement;

      if (!input || !preview || !container) return;

      let objectURL = "";

      input.addEventListener("change", () => {
        const file = input.files?.[0];
        if (objectURL) URL.revokeObjectURL(objectURL);

        if (file) {
          objectURL = URL.createObjectURL(file);
          preview.src = objectURL;
          container.classList.remove("hidden");
        } else {
          container.classList.add("hidden");
          objectURL = "";
        }
      });

      // Handle form submission to exclude empty file inputs
      form.addEventListener("submit", (e) => {
        if (input.files?.length === 0) {
          input.removeAttribute("name");
        }
      });

      window.addEventListener(
        "unload",
        () => objectURL && URL.revokeObjectURL(objectURL),
      );
    });
  </script>
</Layout>
