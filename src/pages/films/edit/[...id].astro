---
import Layout from "../../../layouts/Layout.astro";
import slug from "slug";
import {
  FilmsPaysOptions,
  type FilmsResponse,
} from "../../../pocketbase-types";
import { formatDate } from "../../../utils/utilitaires";
import GenresSelect from "../../../components/GenresSelect.astro";

const { id } = Astro.params;
let message = null;

let film = {} as FilmsResponse;
if (id) {
  film = await Astro.locals.pb.collection("films").getOne(id);
}

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();

  const filmCree = await (
    id
      ? Astro.locals.pb.collection("films").update(id!, data)
      : Astro.locals.pb.collection("films").create(data)
  ).catch((err) => {
    console.error("Erreur de sauvegarde du film : ", err);
    message = err.message;
    console.log("Message d'erreur :", message);
  });
  if (filmCree) {
    return Astro.redirect(`/films/${filmCree.id}-${slug(filmCree.titre)}`);
  }
}

const afficheUrl = film.affiche
  ? Astro.locals.pb.files.getURL(film, film.affiche)
  : null;

const personnesListe = await Astro.locals.pb
  .collection("personnes")
  .getFullList();
---

<Layout>
  <div class="max-w-2xl mx-auto mt-32">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h1 class="card-title text-3xl font-bold mb-6">
          {id ? "Modifier un film" : "Ajouter un film"}
        </h1>
        {message && <div class="alert alert-error mb-4">{message}</div>}
        <form method="post" enctype="multipart/form-data" class="space-y-6" id="film-form">
          {id && <input type="hidden" name="id" value={id} />}
          <input
            type="hidden"
            name="user"
            value={Astro.locals.pb.authStore.record?.id}
          />

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Titre :</span>
            </label>
            <input
              type="text"
              name="titre"
              value={film.titre || ""}
              class="input input-bordered w-full"
              required
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Date de sortie :</span>
            </label>
            <input
              type="date"
              name="date_sortie"
              value={film.date_sortie ? new Date(film.date_sortie).toISOString().split('T')[0] : ""}
              class="input input-bordered w-full"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Durée (en minutes) :</span>
            </label>
            <input
              type="number"
              name="duree_min"
              value={film.duree_min || ""}
              class="input input-bordered w-full"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Synopsis :</span>
            </label>
            <textarea
              name="synopsis"
              rows="4"
              class="textarea textarea-bordered w-full"
            >{film.synopsis || ""}</textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Réalisateur :</span>
            </label>
            <select name="realisateur" class="select select-bordered w-full">
              <option value="">Choisir un réalisateur</option>
              {personnesListe.map(({ nom, prenom, id: pid }) => (
                <option value={pid} selected={film.realisateur === pid}>
                  {prenom} {nom}
                </option>
              ))}
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Producteur(s) :</span>
            </label>
            <select
              name="producteur"
              class="select select-bordered w-full"
              multiple
            >
              <option value="">Choisir un producteur ou plusieurs producteurs</option>
              {personnesListe.map(({ nom, prenom, id: pid }) => (
                <option value={pid} selected={film.producteur?.some(producteur => producteur === pid)}>
                  {prenom} {nom}
                </option>
              ))}
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Acteur(s) :</span>
            </label>
            <select
              name="acteur"
              class="select select-bordered w-full"
              multiple
            >
              <option value="">Choisir un acteur ou plusieurs acteurs</option>
              {personnesListe.map(({ nom, prenom, id: pid }) => (
                <option value={pid} selected={film.acteur?.some(acteur => acteur === pid)}>
                  {prenom} {nom}
                </option>
              ))}
            </select>
          </div>

          <label class="block mb-4">
            <span class="block text-gray-700 mb-2">Affiche :</span>
            <input
              type="file"
              name="affiche"
              id="affiche-input"
              accept="image/*"
              class="file-input file-input-bordered w-full mb-4"
            />
            <div class="flex h-fit items-center justify-between gap-8">
              {
                afficheUrl && (
                  <div class="h-120 w-1/2 ">
                    <span class="block text-gray-600 mb-1">
                      Affiche actuelle :
                    </span>
                    <img
                      src={afficheUrl}
                      alt="Affiche actuelle du film"
                      class="w-full h-full object-cover"
                    />
                  </div>
                )
              }
              <div id="preview-container" class="h-120 w-1/2 hidden">
                <span class="block text-gray-600 mb-1">Nouvelle affiche :</span>
                <img
                  id="preview"
                  alt="Prévisualisation"
                  class="w-full h-full object-cover"
                />
              </div>
            </div>
          </label>

          <div class="form-control mt-8">
            <GenresSelect selectedGenres={film.genres} />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Pays :</span>
            </label>
            <select name="pays" class="select select-bordered w-full">
              <option value="">-- Sélectionnez un pays --</option>
              {Object.entries(FilmsPaysOptions).map(([key, value]) => (
                <option value={value} selected={film.pays === value}>
                  {key}
                </option>
              ))}
            </select>
          </div>

          <div class="form-control mt-8">
            <button type="submit" class="btn btn-primary w-full">
              {id ? "Mettre à jour" : "Ajouter"}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("film-form") as HTMLFormElement;
      const input = document.getElementById(
        "affiche-input",
      ) as HTMLInputElement;
      const preview = document.getElementById("preview") as HTMLImageElement;
      const container = document.getElementById(
        "preview-container",
      ) as HTMLDivElement;

      if (!input || !preview || !container) return;

      let objectURL = "";

      input.addEventListener("change", () => {
        const file = input.files?.[0];
        if (objectURL) URL.revokeObjectURL(objectURL);

        if (file) {
          objectURL = URL.createObjectURL(file);
          preview.src = objectURL;
          container.classList.remove("hidden");
        } else {
          container.classList.add("hidden");
          objectURL = "";
        }
      });

      form.addEventListener("submit", (e) => {
        if (input.files?.length === 0) {
          input.removeAttribute("name");
        }
      });

      window.addEventListener(
        "unload",
        () => objectURL && URL.revokeObjectURL(objectURL),
      );
    });
  </script>
</Layout>
